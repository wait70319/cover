<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 批次壓縮器 (GitHub Pages 穩定版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 FFmpeg v0.10.1 (最穩定版本) -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
    <style>
        /* 旋轉動畫 */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-2xl">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">MP3 批次壓縮神器</h1>

        <!-- 1. 檔案上傳 (加入 multiple 屬性) -->
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">1. 選擇 MP3 檔案 (可多選)</label>
            <input type="file" id="fileInput" accept="audio/mp3" multiple class="block w-full text-sm text-gray-500
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-sm file:font-semibold
              file:bg-blue-50 file:text-blue-700
              hover:file:bg-blue-100
            "/>
            <p class="text-xs text-gray-500 mt-1 ml-2">按住 Ctrl 或 Shift 可以選擇多個檔案</p>
        </div>

        <!-- 2. 選擇品質 -->
        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2">2. 選擇目標品質</label>
            <select id="bitrateSelect" class="block w-full p-2 border border-gray-300 rounded-md">
                <option value="128k">128 kbps (標準)</option>
                <option value="96k">96 kbps (平衡)</option>
                <option value="64k" selected>64 kbps (高壓縮)</option>
                <option value="48k">48 kbps (語音)</option>
                <option value="32k">32 kbps (極限)</option>
            </select>
        </div>

        <!-- 按鈕 -->
        <button id="compressBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50 transition">
            開始批次壓縮
        </button>
        
        <!-- 全局狀態 -->
        <p id="globalStatus" class="text-center text-sm text-gray-600 mt-2 hidden"></p>

        <!-- 檔案列表區域 -->
        <div id="resultsArea" class="mt-6 space-y-3 hidden">
            <h3 class="font-bold text-gray-700 border-b pb-2">處理清單</h3>
            <!-- 這裡會動態插入檔案卡片 -->
            <ul id="fileList" class="space-y-2"></ul>
        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        
        // 初始化 FFmpeg 實例
        const ffmpeg = createFFmpeg({ 
            log: false, // 關閉大量日誌以提升效能
            corePath: 'https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js'
        });

        const fileInput = document.getElementById('fileInput');
        const bitrateSelect = document.getElementById('bitrateSelect');
        const compressBtn = document.getElementById('compressBtn');
        const globalStatus = document.getElementById('globalStatus');
        const resultsArea = document.getElementById('resultsArea');
        const fileList = document.getElementById('fileList');

        // 載入 FFmpeg
        async function loadFFmpeg() {
            if (ffmpeg.isLoaded()) return true;
            try {
                globalStatus.classList.remove('hidden');
                globalStatus.innerText = "正在載入核心組件 (約 25MB，首次需稍候)...";
                await ffmpeg.load();
                return true;
            } catch (error) {
                console.error(error);
                globalStatus.innerText = "載入失敗，請檢查網路或使用電腦版瀏覽器。";
                globalStatus.classList.add('text-red-500');
                return false;
            }
        }

        // 格式化檔案大小
        function formatSize(bytes) {
            return (bytes / 1024 / 1024).toFixed(2) + ' MB';
        }

        // 主邏輯
        compressBtn.addEventListener('click', async () => {
            const files = fileInput.files;
            if (files.length === 0) {
                alert('請至少選擇一個檔案！');
                return;
            }

            // 1. 確保 FFmpeg 已載入
            const isLoaded = await loadFFmpeg();
            if (!isLoaded) return;

            // 2. 初始化 UI
            compressBtn.disabled = true;
            resultsArea.classList.remove('hidden');
            fileList.innerHTML = ''; // 清空列表
            globalStatus.innerText = `準備處理 ${files.length} 個檔案...`;

            const bitrate = bitrateSelect.value;

            // 3. 建立檔案列表 UI
            const fileItems = [];
            Array.from(files).forEach((file, index) => {
                const li = document.createElement('li');
                li.className = "bg-gray-50 p-3 rounded flex items-center justify-between border border-gray-200";
                li.innerHTML = `
                    <div class="flex items-center min-w-0 flex-1">
                        <div id="icon-${index}" class="text-gray-400 mr-3">Wait</div>
                        <div class="truncate">
                            <p class="text-sm font-medium text-gray-800 truncate" title="${file.name}">${file.name}</p>
                            <p class="text-xs text-gray-500">${formatSize(file.size)}</p>
                        </div>
                    </div>
                    <div id="action-${index}" class="ml-4 text-sm text-gray-500">等待中...</div>
                `;
                fileList.appendChild(li);
                fileItems.push({ file, index, li });
            });

            // 4. 逐一處理檔案 (序列處理，避免記憶體爆炸)
            for (let i = 0; i < fileItems.length; i++) {
                const { file, index } = fileItems[i];
                const actionDiv = document.getElementById(`action-${index}`);
                const iconDiv = document.getElementById(`icon-${index}`);

                // 更新狀態：處理中
                globalStatus.innerText = `正在處理 (${i + 1}/${files.length}): ${file.name}`;
                iconDiv.innerHTML = `<div class="loader"></div>`;
                actionDiv.innerText = "壓縮中...";
                actionDiv.className = "ml-4 text-sm text-blue-600 font-bold";

                try {
                    // 為了避免檔名衝突，統一使用 temp_input.mp3
                    const inputName = 'temp_input.mp3';
                    const outputName = 'temp_output.mp3';

                    // 寫入虛擬檔案系統
                    ffmpeg.FS('writeFile', inputName, await fetchFile(file));

                    // 執行壓縮
                    await ffmpeg.run('-i', inputName, '-b:a', bitrate, outputName);

                    // 讀取結果
                    const data = ffmpeg.FS('readFile', outputName);
                    
                    // 建立下載連結
                    const blob = new Blob([data.buffer], { type: 'audio/mp3' });
                    const url = URL.createObjectURL(blob);
                    const newSize = formatSize(blob.size);

                    // 清理虛擬記憶體 (重要！否則處理多個檔案會記憶體不足)
                    ffmpeg.FS('unlink', inputName);
                    ffmpeg.FS('unlink', outputName);

                    // 更新 UI：完成
                    iconDiv.innerHTML = `<span class="text-green-500">✔</span>`;
                    actionDiv.innerHTML = `
                        <div class="flex flex-col items-end">
                            <span class="text-xs text-gray-500 mb-1">-> ${newSize}</span>
                            <a href="${url}" download="compressed_${file.name}" class="bg-green-500 hover:bg-green-600 text-white text-xs py-1 px-3 rounded transition">
                                下載
                            </a>
                        </div>
                    `;

                } catch (err) {
                    console.error(err);
                    iconDiv.innerHTML = `<span class="text-red-500">✘</span>`;
                    actionDiv.innerText = "失敗";
                    actionDiv.className = "ml-4 text-sm text-red-500";
                    
                    // 嘗試清理，以防萬一
                    try { ffmpeg.FS('unlink', 'temp_input.mp3'); } catch(e){}
                    try { ffmpeg.FS('unlink', 'temp_output.mp3'); } catch(e){}
                }
            }

            globalStatus.innerText = "全部任務完成！";
            compressBtn.disabled = false;
        });
    </script>
</body>
</html>
